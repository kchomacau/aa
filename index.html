<!DOCTYPE html>
<html lang="zh-tw">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>AA Cost Calculator</title>
	<meta property="og:title" content="AA Cost Calculator" />
	<meta property="og:description" content="AA制？輕鬆啦！" />
</head>
<body>

<h2>AA Cost Calculator</h2>
<p>by K. C. Ho</p>

<p>&nbsp;</p>
<div class="lines">
	<p>使用說明：</p>
	<p>1. 先於 "Result" 輸入參與 AA 制的人；</p>
	<p>2. 於 "Dishes" 輸入每項東西的價錢 (如 "38.5")；</p>
	<p>3. 勾選需要分擔該項東西的人；</p>
	<p>4. (如適用) 勾選 "W_TAX" 以啟用折扣或稅項；</p>
	<p>5. 於 "Price = $ &times;" 後方空格輸入折扣或稅項 (預設為 "1"，表示不附加任何折扣或稅項；服務費15%，請輸入"1.15"；有八折優惠，請輸入"0.8")。</p>
</div>
<p>&nbsp;</p>

<div class="wrap">
	<p>Dishes</p>
	<p><a href="javascript:addDish()">+ Add Dish</a></p>
	<table>
		<tr id="price-head">
			<th>W_TAX</th>
			<th colspan="2">Price</th>
		</tr>
		<tr id="d1" class="dish-row">
			<td><input type="checkbox" class="d-tax" checked></td>
			<td colspan="2"><input type="text" class="d-price" placeholder="$"></td>
		</tr>
		<tr id="tax" class="tax">
			<td colspan="3" class="wtax-if">if(W_TAX == true):</td>
			<td rowspan="2" class="colspan" valign="bottom"><a href="javascript:calc()" class="highlight">Calculate >></a></td>
		</tr>
		<tr class="tax">
			<td class="right-align">Price</td>
			<td> = $ &times;&nbsp;</td>
			<td><input type="text" id="d-tax" value="1"></td>
		</tr>
	</table>
</div>

<div class="wrap">
	<p id="people-anchor"><strong>Result</strong></p>
	<p><a href="javascript:addPerson()">+ Add Person</a></p>
	<table id="people-table">
	</table>
</div>

<div class="warehouse">
	<table>
		<tr>
			<td id="price-checkbox"><input type="checkbox" id="nchk"></td>
		</tr>
		<tr id="person-row">
			<td class="n">#</td>
			<td>
				<input type="text" id="ntxt" placeholder="(Name?)">
			</td>
			<td class="p">$0.0</td>
		</tr>
	</table>
</div>

<style>
body, p, h1, h2 {
	margin: 0;
	padding: 0;
	font-family: Helvatica, Arial, sans-serif;
}
body {
	padding: 15px;
}
body, p {
	font-size: 13px;
}
.wrap {
	padding: 15px 0;
}
table {
	border-collapse: collapse;
}
th, td {
	text-align: center;
}
th {
	padding: 0 2px;
}
table,
input[type="text"] {
	width: 100%;
}
input[type="text"] {
	min-width: 100px;
	border: 2px solid #eee;
	font-size: 13px;
	padding: 5px;
	outline: 0;
	-webkit-box-sizing: border-box;
	-moz-box-sizing: border-box;
	box-sizing: border-box;
}
input[type="checkbox"] {
	width:30px;
	height:30px;
}
div.warehouse {
	display: none;
}
a {
	display: block;
	padding: 10px;
	background: #cddc39;
	-webkit-border-radius: 2px;
	-moz-border-radius: 2px;
	border-radius: 2px;
	color: #fff;
	margin: 8px 0 10px;
	text-align: center;
	text-decoration: none;
}
a.highlight {
	background: dodgerblue;
	font-weight: bold;
}
strong {
	font-size: 18px;
	font-weight: normal;
}
tr#tax {
	border-top: 5px solid #eee;
}
tr#tax td {
	padding-top: 5px;
}
tr.tax td {
	white-space: nowrap;
}
td.wtax-if {
	text-align: left;
	font-family: monospace;
}
td.right-align {
	text-align: right;
}
td a {
	margin: 0;
}
.lines p {
	padding-top: 5px;
}
</style>

<script
	src="https://code.jquery.com/jquery-3.3.1.min.js"
	integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
	crossorigin="anonymous"></script>

<script>
var curMaxPerson = 0;
var curMaxDish = 1;

function addDish(){
	var newDiv = $("#d1").clone()
		.attr('id', 'd' + (++curMaxDish));
	newDiv.insertBefore("#tax");
}

function addPerson(){
	var curPerson = ++curMaxPerson;

	var div = $("#person-row").clone();
	div.attr("id", "");
	div.find(".n").text('#' + curPerson);
	div.find("#ntxt")
		.attr("id", "p" + curPerson + "-name")
		.on('keyup', changePName);
	div.find(".p")
		.attr('id', 'p' + curPerson + '-total');
	$("#people-table").append(div);
	$("#price-head").append(
		$("<th></th>")
			.attr('id', 'p' + curPerson + '-n')
	);

	var checkboxDiv = $("#price-checkbox").clone();
	checkboxDiv.attr('id', '');
	checkboxDiv.find('#nchk').attr('id', '').addClass('d-p' + curPerson);

	$(".dish-row").append(checkboxDiv);
	$("td.colspan").attr("colspan", curMaxPerson);
}

var curThread = 0;

function changePName_proc(thisThread) {
	if(thisThread !== curThread){
		return;
	}

	var persons = [];

	for(var id=1; id<=curMaxPerson; id++){
		var name = $('#p' + id + '-name').val();
		$('#p' + id + '-n').text(name);

		if(name !== ''){
			persons.push(name);
		}
	}
	localStorage.persons = JSON.stringify(persons);
}

function fetchNameFromLS(){
	var persons = JSON.parse(localStorage.persons);
	for(var id=0; id<persons.length; id++){
		addPerson();
	}
	for(var id=0; id<persons.length; id++){
		$('#p' + (id+1) + '-name').val(persons[id]);
		$('#p' + (id+1) + '-n').text(persons[id]);
	}
}

for(var i=0; i<2; i++){
	addDish();
}

if(localStorage.persons) {
	fetchNameFromLS();
}
else{
	for(var i=0; i<2; i++) {
		addPerson();
	}
}

function changePName(){
	var thisThread = ++curThread;

	window.setTimeout(function(){
		changePName_proc(thisThread);
	}, 100);
}

function calc(){

	var price = [];
	var tax = parseFloat($("#d-tax").val());

	if(isNaN(tax)) {
		tax = 1;
	}

	for(var i=1; i<=curMaxDish; i++){
		var this_row = $("#d" + i);
		var this_price = parseFloat(this_row.find(".d-price").val());

		var price_for = [];	// person

		for(var ps=1; ps<=curMaxPerson; ps++) {
			if(!price[ps]) {
				price[ps] = 0;
			}
			if(this_row.find(".d-p"+ps).prop('checked')) {
				price_for.push(ps);
			}
		}

		if(isNaN(this_price)){
			continue;
		}

		if(price_for.length===0) {
			for(var ps=1; ps<=curMaxPerson; ps++){
				price_for.push(ps);
			}
		}

		var shared_price = this_price / price_for.length;

		if(this_row.find('.d-tax').prop('checked')) {
			shared_price = shared_price * tax;
		}

		for(var ind=0; ind<price_for.length; ind++){
			price[price_for[ind]] += shared_price;
		}
	}

	for(var ps=1; ps<=curMaxPerson; ps++){
		$("#p"+ps+"-total").text('$' + price[ps].toFixed(1));
	}

	window.scrollTo(0, document.getElementById("people-anchor").offsetTop);
}
</script>
	
</body>
</html>